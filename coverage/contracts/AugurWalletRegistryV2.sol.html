<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts/AugurWalletRegistryV2.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">contracts/</a> AugurWalletRegistryV2.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">48.15% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>52/108</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">27.78% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>10/36</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">42.11% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>8/19</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">47.79% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>54/113</span>
      </div>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">26×</span>
<span class="cline-any cline-yes">26×</span>
<span class="cline-any cline-yes">26×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">pragma solidity 0.5.15;
pragma experimental ABIEncoderV2;
&nbsp;
import 'ROOT/gsn/v2/BaseRelayRecipient.sol';
import 'ROOT/gsn/v2/BasePaymaster.sol';
import 'ROOT/gsn/v2/TrustedForwarder.sol';
import 'ROOT/gsn/v2/interfaces/IRelayHub.sol';
import 'ROOT/IAugur.sol';
import 'ROOT/IAugurWallet.sol';
import 'ROOT/AugurWallet.sol';
import 'ROOT/trading/IAugurTrading.sol';
import 'ROOT/libraries/Initializable.sol';
import 'ROOT/libraries/ContractExists.sol';
import 'ROOT/libraries/token/IERC1155.sol';
import 'ROOT/reporting/IAffiliates.sol';
import 'ROOT/libraries/math/SafeMathUint256.sol';
import 'ROOT/libraries/LibBytes.sol';
import 'ROOT/libraries/ContractExists.sol';
import 'ROOT/uniswap/interfaces/IUniswapV2Factory.sol';
import 'ROOT/uniswap/interfaces/IUniswapV2Pair.sol';
import 'ROOT/uniswap/interfaces/IWETH.sol';
&nbsp;
&nbsp;
contract AugurWalletRegistryV2 is Initializable, BaseRelayRecipient, TrustedForwarder {
    using LibBytes for bytes;
    using ContractExists for address;
&nbsp;
    using SafeMathUint256  for uint256;
&nbsp;
    event ExecuteTransactionStatus(bool success, bool fundingSuccess);
&nbsp;
    IRelayHub internal relayHub;
&nbsp;
    IAugur public augur;
    IAugurTrading public augurTrading;
&nbsp;
    IERC20 public cash;
    address public affiliates;
    address public shareToken;
    address public createOrder;
    address public fillOrder;
    address public zeroXTrade;
    address public otherRegistry;
&nbsp;
    IUniswapV2Pair public ethExchange;
    IWETH public WETH;
    bool public token0IsCash;
&nbsp;
    uint256 private constant MAX_APPROVAL_AMOUNT = 2 ** 256 - 1;
    uint256 private constant MAX_TX_FEE_IN_ETH = 10**17;
    uint256 private constant POST_RELAY_GAS_COST = 200000;
&nbsp;
    // Gas stipends for acceptRelayedCall, preRelayedCall and postRelayedCall
    uint256 constant private ACCEPT_RELAYED_CALL_GAS_LIMIT = 50000;
    uint256 constant private PRE_RELAYED_CALL_GAS_LIMIT = 5000;
    uint256 constant private POST_RELAYED_CALL_GAS_LIMIT = 200000;
&nbsp;
<span class="fstat-no" title="function not covered" >    modifier relayHubOnly(</span>) {
<span class="cstat-no" title="statement not covered" >        require(msg.sender == getHubAddr(), "Function can only be called by RelayHub")</span>;
        _;
    }
&nbsp;
    function initialize(IAugur _augur, IAugurTrading _augurTrading) public payable beforeInitialized returns (bool) {
        <span class="missing-if-branch" title="else path not taken" >E</span>require(msg.value &gt;= MAX_TX_FEE_IN_ETH, "Must provide initial Max TX Fee Deposit");
        endInitialization();
        augur = _augur;
        trustedForwarder = address(this);
        relayHub = IRelayHub(_augurTrading.lookup("RelayHubV2"));
        cash = IERC20(_augur.lookup("Cash"));
        affiliates = augur.lookup("Affiliates");
        shareToken = augur.lookup("ShareToken");
&nbsp;
        augurTrading = _augurTrading;
        createOrder = _augurTrading.lookup("CreateOrder");
        fillOrder = _augurTrading.lookup("FillOrder");
        zeroXTrade = _augurTrading.lookup("ZeroXTrade");
        WETH = IWETH(_augurTrading.lookup("WETH9"));
        otherRegistry = _augurTrading.lookup("AugurWalletRegistry");
        IUniswapV2Factory _uniswapFactory = IUniswapV2Factory(_augur.lookup("UniswapV2Factory"));
        address _ethExchangeAddress = _uniswapFactory.getPair(address(WETH), address(cash));
        <span class="missing-if-branch" title="if path not taken" >I</span>if (_ethExchangeAddress == address(0)) {
<span class="cstat-no" title="statement not covered" >            _ethExchangeAddress = _uniswapFactory.createPair(address(WETH), address(cash))</span>;
        }
        ethExchange = IUniswapV2Pair(_ethExchangeAddress);
        token0IsCash = ethExchange.token0() == address(cash);
&nbsp;
        relayHub.depositFor.value(address(this).balance)(address(this));
        return true;
    }
&nbsp;
    function getGasLimits() external pure returns (GSNTypes.GasLimits memory limits) {
        return GSNTypes.GasLimits(
            ACCEPT_RELAYED_CALL_GAS_LIMIT,
            PRE_RELAYED_CALL_GAS_LIMIT,
            POST_RELAYED_CALL_GAS_LIMIT
        );
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function getHubAddr() public view returns (address</span>) {
<span class="cstat-no" title="statement not covered" >        return address(relayHub);</span>
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function acceptRelayedCall(GSNTypes.RelayRequest calldata relayRequest, bytes calldata approvalData, uint256 maxPossibleGas) external view returns (bytes memory context</span>) {
        (approvalData);
        // executeWalletTransaction is the only encodedFunction that can succesfully be called through the relayHub
<span class="cstat-no" title="statement not covered" >        uint256 _payment = getPaymentFromEncodedFunction(relayRequest.encodedFunction);</span>
<span class="cstat-no" title="statement not covered" >        (uint112 _reserve0, uint112 _reserve1, uint32 _blockTimestampLast) = ethExchange.getReserves();</span>
<span class="cstat-no" title="statement not covered" >        uint256 _maxDaiNeeded = getAmountIn(maxPossibleGas, token0IsCash ? _reserve0 : _reserve1, token0IsCash ? _reserve1 : _reserve0);</span>
<span class="cstat-no" title="statement not covered" >        require(_payment &gt; _maxDaiNeeded, "Transaction cost too high")</span>;
<span class="cstat-no" title="statement not covered" >        address _walletAddress = getCreate2WalletAddress(relayRequest.relayData.senderAddress);</span>
<span class="cstat-no" title="statement not covered" >        require(_payment &lt;= cash.balanceOf(_walletAddress), "Insufficient balance")</span>;
<span class="cstat-no" title="statement not covered" >        return abi.encode(_walletAddress, _payment);</span>
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function getPaymentFromEncodedFunction(bytes memory _encodedFunction) private pure returns (uint256</span>) {
<span class="cstat-no" title="statement not covered" >        bytes memory _encodedFunctionParams = _encodedFunction.sliceDestructive(4, _encodedFunction.length);</span>
<span class="cstat-no" title="statement not covered" >        (address _to, bytes memory _data, uint256 _value, uint256 _payment, address _affilate, bytes32 _fingerprint) = abi.decode(_encodedFunctionParams, (address, bytes, uint256, uint256, address, bytes32));</span>
<span class="cstat-no" title="statement not covered" >        return _payment;</span>
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function preRelayedCall(bytes calldata context) external pure returns (bool</span>) {
<span class="cstat-no" title="statement not covered" >        return true;</span>
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function postRelayedCall(bytes calldata context, bool success, bytes32 preRetVal, uint256 gasUseWithoutPost, GSNTypes.GasData calldata gasData) external relayHubOnly returns (bool</span>) {
        (success, preRetVal);
<span class="cstat-no" title="statement not covered" >        (address _walletAddress, uint256 _payment) = abi.decode(context, (address, uint256));</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >        uint256 _ethActualCharge = relayHub.calculateCharge(gasUseWithoutPost + POST_RELAY_GAS_COST, gasData);</span>
<span class="cstat-no" title="statement not covered" >        (uint112 _reserve0, uint112 _reserve1, uint32 _blockTimestampLast) = ethExchange.getReserves();</span>
<span class="cstat-no" title="statement not covered" >        uint256 _tokenActualCharge = getAmountIn(_ethActualCharge, token0IsCash ? _reserve0 : _reserve1, token0IsCash ? _reserve1 : _reserve0);</span>
&nbsp;
        // Refund payer excess Cash
<span class="cstat-no" title="statement not covered" >        cash.transfer(_walletAddress, _payment - _tokenActualCharge)</span>;
&nbsp;
        // Get ETH with our Cash balance from Uniswap
<span class="cstat-no" title="statement not covered" >        uint256 _cashBalance = cash.balanceOf(address(this));</span>
<span class="cstat-no" title="statement not covered" >        uint256 _ethReceived = getAmountOut(_cashBalance, token0IsCash ? _reserve0 : _reserve1, token0IsCash ? _reserve1 : _reserve0);</span>
<span class="cstat-no" title="statement not covered" >        cash.transfer(address(ethExchange), _cashBalance)</span>;
<span class="cstat-no" title="statement not covered" >        ethExchange.swap(token0IsCash ? 0 : _ethReceived, token0IsCash ? _ethReceived : 0, address(this), "")</span>;
<span class="cstat-no" title="statement not covered" >        WETH.withdraw(_ethReceived)</span>;
&nbsp;
        // Top off Relay Hub balance with whatever ETH we have
<span class="cstat-no" title="statement not covered" >        uint256 _depositAmount = address(this).balance;</span>
<span class="cstat-no" title="statement not covered" >        _depositAmount = _depositAmount.min(2 ether)</span>; // This is the maximum single RelayHub deposit
<span class="cstat-no" title="statement not covered" >        relayHub.depositFor.value(_depositAmount)</span>(address(this));
&nbsp;
<span class="cstat-no" title="statement not covered" >        return true;</span>
    }
&nbsp;
    // Returns whether the signer eth balance was funded as desired
    function fundMsgSender(uint256 _desiredSignerBalance, uint256 _maxExchangeRateInDai) private returns (bool) {
        address _msgSender = address(_msgSender());
        IAugurWallet _wallet = getWallet(_msgSender);
        uint256 _msgSenderBalance = _msgSender.balance;
        <span class="missing-if-branch" title="else path not taken" >E</span>if (_msgSenderBalance &gt;= _desiredSignerBalance) {
            return true;
        }
<span class="cstat-no" title="statement not covered" >        uint256 _ethDelta = _desiredSignerBalance - _msgSenderBalance;</span>
<span class="cstat-no" title="statement not covered" >        (uint112 _reserve0, uint112 _reserve1, uint32 _blockTimestampLast) = ethExchange.getReserves();</span>
<span class="cstat-no" title="statement not covered" >        uint256 _cashAmount = getAmountIn(_ethDelta, token0IsCash ? _reserve0 : _reserve1, token0IsCash ? _reserve1 : _reserve0);</span>
<span class="cstat-no" title="statement not covered" >        uint256 _exchangeRate = _cashAmount.mul(10**18).div(_ethDelta);</span>
<span class="cstat-no" title="statement not covered" >        if (_maxExchangeRateInDai &lt; _exchangeRate) {</span>
<span class="cstat-no" title="statement not covered" >            return false;</span>
        }
<span class="cstat-no" title="statement not covered" >        _wallet.transferCash(address(ethExchange), _cashAmount)</span>;
<span class="cstat-no" title="statement not covered" >        ethExchange.swap(token0IsCash ? 0 : _ethDelta, token0IsCash ? _ethDelta : 0, address(this), "")</span>;
<span class="cstat-no" title="statement not covered" >        WETH.withdraw(_ethDelta)</span>;
<span class="cstat-no" title="statement not covered" >        (bool _success,) = _msgSender.call.value(_ethDelta)("");</span>
<span class="cstat-no" title="statement not covered" >        return _success;</span>
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function getAmountOut(uint amountIn, uint reserveIn, uint reserveOut) public pure returns (uint amountOut</span>) {
<span class="cstat-no" title="statement not covered" >        require(amountIn &gt; 0)</span>;
<span class="cstat-no" title="statement not covered" >        require(reserveIn &gt; 0 &amp;&amp; reserveOut &gt; 0)</span>;
<span class="cstat-no" title="statement not covered" >        uint amountInWithFee = amountIn.mul(997);</span>
<span class="cstat-no" title="statement not covered" >        uint numerator = amountInWithFee.mul(reserveOut);</span>
<span class="cstat-no" title="statement not covered" >        uint denominator = reserveIn.mul(1000).add(amountInWithFee);</span>
<span class="cstat-no" title="statement not covered" >        amountOut = numerator / denominator</span>;
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function getAmountIn(uint amountOut, uint reserveIn, uint reserveOut) public pure returns (uint amountIn</span>) {
<span class="cstat-no" title="statement not covered" >        require(amountOut &gt; 0)</span>;
<span class="cstat-no" title="statement not covered" >        require(reserveIn &gt; 0 &amp;&amp; reserveOut &gt; 0)</span>;
<span class="cstat-no" title="statement not covered" >        uint numerator = reserveIn.mul(amountOut).mul(1000);</span>
<span class="cstat-no" title="statement not covered" >        uint denominator = reserveOut.sub(amountOut).mul(997);</span>
<span class="cstat-no" title="statement not covered" >        amountIn = (numerator / denominator).add(1)</span>;
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function trustedCreateAugurWallet(address _owner, address _referralAddress, bytes32 _fingerprint) public returns (IAugurWallet</span>) {
<span class="cstat-no" title="statement not covered" >        require(msg.sender == otherRegistry)</span>;
<span class="cstat-no" title="statement not covered" >        return createAugurWalletInternal(_owner, _referralAddress, _fingerprint);</span>
    }
&nbsp;
    function createAugurWallet(address _referralAddress, bytes32 _fingerprint) private returns (IAugurWallet) {
        address _owner = _msgSender();
        return createAugurWalletInternal(_owner, _referralAddress, _fingerprint);
    }
&nbsp;
    function createAugurWalletInternal(address _owner, address _referralAddress, bytes32 _fingerprint) private returns (IAugurWallet) {
        // Create2 creation of wallet based on owner
        address _walletAddress = getCreate2WalletAddress(_owner);
        <span class="missing-if-branch" title="if path not taken" >I</span>if (_walletAddress.exists()) {
<span class="cstat-no" title="statement not covered" >            return IAugurWallet(_walletAddress);</span>
        }
        {
            bytes32 _salt = keccak256(abi.encodePacked(_owner));
            bytes memory _deploymentData = abi.encodePacked(type(AugurWallet).creationCode);
            assembly {
                _walletAddress := create2(0x0, add(0x20, _deploymentData), mload(_deploymentData), _salt)
                if iszero(extcodesize(_walletAddress)) {
                    revert(0, 0)
                }
            }
        }
        IAugurWallet _wallet = IAugurWallet(_walletAddress);
        _wallet.initialize(_owner, _referralAddress, _fingerprint, address(augur), otherRegistry, cash, IAffiliates(affiliates), IERC1155(shareToken), createOrder, fillOrder, zeroXTrade);
        return _wallet;
    }
&nbsp;
    function getCreate2WalletAddress(address _owner) public view returns (address) {
        bytes1 _const = 0xff;
        bytes32 _salt = keccak256(abi.encodePacked(_owner));
        return address(uint160(uint256(keccak256(abi.encodePacked(
            _const,
            address(this),
            _salt,
            keccak256(abi.encodePacked(type(AugurWallet).creationCode))
        )))));
    }
&nbsp;
    /**
     * @notice Get the Wallet for the given account
     * @param _account The account to look up
     * @return IAugurWallet for the account or 0x if none exists
     */
    function getWallet(address _account) public view returns (IAugurWallet) {
        address _walletAddress = getCreate2WalletAddress(_account);
        if (!_walletAddress.exists()) {
            return IAugurWallet(0);
        }
        return IAugurWallet(_walletAddress);
    }
&nbsp;
    // 1. Create a user's wallet if it does not exist
    // 2. Get funds from the wallet to compensate this contract for paying the relayer
    // 3. Execute the transaction and return success status, or revert if appropriate
    // 4. Fund the signer with ETH as specified
    function executeWalletTransaction(address _to, bytes calldata _data, uint256 _value, uint256 _payment, address _referralAddress, bytes32 _fingerprint, uint256 _desiredSignerBalance, uint256 _maxExchangeRateInDai, bool _revertOnFailure) external {
        address _user = _msgSender();
        IAugurWallet _wallet = getWallet(_user);
        if (_wallet == IAugurWallet(0)) {
            _wallet = createAugurWallet(_referralAddress, _fingerprint);
        }
        // If the user is having this sent via relay we need to reimburse this contract for paying the relayer. We do the payment here to avoid complexity handling the wallet not existing in the pre relay call
        <span class="missing-if-branch" title="if path not taken" >I</span>if (_user != msg.sender) {
<span class="cstat-no" title="statement not covered" >            _wallet.transferCash(address(this), _payment)</span>;
        }
        bool _success = _wallet.executeTransaction(_to, _data, _value);
        // We need to be able to fail in order to get accurate gas estimates. We only allow this however when not using the relayhub since otherwise funds could be drained this way
        <span class="missing-if-branch" title="if path not taken" >I</span>if (_user == msg.sender &amp;&amp; _revertOnFailure) {
<span class="cstat-no" title="statement not covered" >            require(_success, "Transaction Execution Failed")</span>;
        }
        // We keep the signing account's ETH balance funded up to an offchain provided value so it can send txs itself without the use of a relay
        bool _fundingSuccess = fundMsgSender(_desiredSignerBalance, _maxExchangeRateInDai);
        emit ExecuteTransactionStatus(_success, _fundingSuccess);
    }
&nbsp;
    /// check current deposit on relay hub.
<span class="fstat-no" title="function not covered" >    function getRelayHubDeposit() public view returns (uint</span>) {
<span class="cstat-no" title="statement not covered" >        return relayHub.balanceOf(address(this));</span>
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function () external payabl</span>e {}
}</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Tue Jun 16 2020 12:04:17 GMT-0700 (Pacific Daylight Time)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
